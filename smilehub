local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- è¨­å®šå€¤
local NEARBY_RANGE = 25 -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã€Œè¿‘ãã€ã¨åˆ¤å®šã™ã‚‹è·é›¢ (Studs)
local GRAB_INTERVAL = 0.5 -- æ´ã¿ãƒ»è§£æ”¾ã‚’ç¹°ã‚Šè¿”ã™é–“éš” (ç§’)
local blobalter = 1 -- å·¦å³ã®æ¤œå‡ºå™¨ã‚’äº¤äº’ã«ä½¿ç”¨

-- ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¹ã®ç¢ºèª (ã‚²ãƒ¼ãƒ å†…ã®ãƒ‘ã‚¹ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„)
local GrabEvents = ReplicatedStorage:FindFirstChild("GrabEvents")
local CreatureEvents = ReplicatedStorage:FindFirstChild("CreatureEvents")
local tossEvent = CreatureEvents and CreatureEvents:FindFirstChild("CreatureToss")
local endGrabEvent = GrabEvents and GrabEvents:FindFirstChild("EndGrabEarly")

-- ã‚³ãƒ«ãƒ¼ãƒãƒ³ã¨çŠ¶æ…‹ç®¡ç†
local ForceGrabCoroutine = nil
local uiToggle = nil 

-- Rayfield UIã®ãƒ­ãƒ¼ãƒ‰
local RayfieldSuccess, Rayfield = pcall(function()
    return loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
end)

if not RayfieldSuccess or not Rayfield then 
    warn("âŒ Rayfield UI ãƒ­ãƒ¼ãƒ‰å¤±æ•—ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç¶šè¡Œã§ãã¾ã›ã‚“ã€‚")
    return
end

-- è£œåŠ©é–¢æ•°: æŒ‡å®šã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦ªã®ä¸‹ã«ã‚ã‚‹ã‹ç¢ºèª
local function isDescendantOf(descendant, ancestor)
    while descendant and descendant ~= ancestor and descendant.Parent do
        descendant = descendant.Parent
    end
    return descendant == ancestor
end

-- Blobmanãƒ¢ãƒ‡ãƒ«ã®ç‰¹å®šï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä¹—è»Šã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰
local function findActiveBlobman()
    for _, v in pairs(Workspace:GetDescendants()) do
        if v.Name == "CreatureBlobman" and v:FindFirstChild("VehicleSeat") and v.VehicleSeat:FindFirstChild("SeatWeld") then
            if LocalPlayer.Character and isDescendantOf(v.VehicleSeat.SeatWeld.Part1, LocalPlayer.Character) then
                return v
            end
        end
    end
    return nil
end

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ´ã‚€ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã‚‹
local function blobGrabPlayer(player, blobman)
    if not player or not player.Character or not blobman then return end
    local targetHRP = player.Character:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end
    
    -- å·¦å³ã®æ¤œå‡ºå™¨ã‚’äº¤äº’ã«ä½¿ç”¨
    local grabPart = blobalter == 1 and blobman:FindFirstChild("LeftDetector") or blobman:FindFirstChild("RightDetector")
    local weldPart = grabPart and grabPart:FindFirstChild(blobalter == 1 and "LeftWeld" or "RightWeld")
    blobalter = blobalter == 1 and 2 or 1 

    if grabPart and weldPart and blobman:FindFirstChild("BlobmanSeatAndOwnerScript") then
        local grabEvent = blobman.BlobmanSeatAndOwnerScript:FindFirstChild("CreatureGrab")
        if grabEvent then
            local args = {[1] = grabPart, [2] = targetHRP, [3] = weldPart}
            pcall(function() grabEvent:FireServer(unpack(args)) end)
        end
    end
end

-- è‡ªå‹•æ´ã¿ãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢ã™ã‚‹é–¢æ•°
local function stopForcedGrab()
    if ForceGrabCoroutine then coroutine.close(ForceGrabCoroutine) ForceGrabCoroutine = nil end
    if uiToggle and uiToggle.CurrentValue then 
        uiToggle:SetValue(false) 
    end
    Rayfield:Notify({Title = "âœ… åœæ­¢", Content = "è‡ªå‹•æ´ã¿é€£æ‰“ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚", Duration = 2})
end

-- è‡ªå‹•æ´ã¿ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
local function startForcedGrab()
    if ForceGrabCoroutine then coroutine.close(ForceGrabCoroutine) end
    
    local blobmanModel = findActiveBlobman()
    if not blobmanModel then
        Rayfield:Notify({Title = "âŒ ERROR", Content = "ãƒ–ãƒ­ãƒ³ã‚°ãƒãƒ³ã«ä¹—è»Šã—ã¦ã„ã¾ã›ã‚“ã€‚", Duration = 3})
        return false
    end
    
    Rayfield:Notify({Title = "âœ… èµ·å‹•", Content = string.format("è¿‘ãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ %.1fç§’æ¯ã«æ´ã¿é€£æ‰“ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚", GRAB_INTERVAL), Duration = 3})

    -- æ´ã¿ãƒ«ãƒ¼ãƒ—
    ForceGrabCoroutine = coroutine.create(function()
        while true do
            local targets = {}
            local HRP = LocalPlayer.Character and LocalPlayer.Character.HumanoidRootPart
            
            if HRP then
                for _, player in ipairs(Players:GetChildren()) do
                    if player ~= LocalPlayer and player.Character then
                        local targetHRP = player.Character:FindFirstChild("HumanoidRootPart")
                        if targetHRP and (targetHRP.Position - HRP.Position).Magnitude < NEARBY_RANGE then
                            -- è¿‘ãã«ã„ã‚‹è‡ªåˆ†ä»¥å¤–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹
                            table.insert(targets, player)
                        end
                    end
                end
            end

            -- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå…¨å“¡ã«æ´ã¿ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
            for _, player in ipairs(targets) do
                coroutine.wrap(function() blobGrabPlayer(player, blobmanModel) end)()
            end

            -- æ´ã‚“ã§ã™ãã«é›¢ã™ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€£æ‰“ (æ´ã¿å‹•ä½œã‚’å¼·åˆ¶çµ‚äº†ã•ã›ã‚‹)
            if tossEvent then pcall(function() tossEvent:FireServer() end) end
            if endGrabEvent then pcall(function() endGrabEvent:FireServer() end) end
            
            -- 0.5ç§’å¾…æ©Ÿ
            wait(GRAB_INTERVAL)
        end
    end)
    coroutine.resume(ForceGrabCoroutine)
    return true
end


-- UIã®å®šç¾©ã¨èµ·å‹•
local function createKickMenu()
    local Window = Rayfield:CreateWindow({
        Name = "ğŸ¤– è‡ªå‹•æ´ã¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (Auto Grab Nearby)",
        Icon = 0, 
        LoadingTitle = "BLOBMAN AUTO GRAB READY", 
        LoadingSubtitle = "è‡ªå‹•æ´ã¿æ©Ÿèƒ½ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ", 
        ShowText = "AUTO GRAB", 
        Theme = "Default", 
        ToggleUIKeybind = "L", 
        ConfigurationSaving = {Enabled = false}, 
        KeySystem = false,
    })

    local KickTab = Window:CreateTab("æ¬„1:è‡ªå‹•æ´ã¿è¨­å®š", 10427807755)

    KickTab:CreateSection("ãƒ–ãƒ­ãƒ³ã‚°ãƒãƒ³åˆ¶å¾¡ (è¦ä¹—è»Š)")
    uiToggle = KickTab:CreateToggle({
        Name = string.format("ON/OFF: è¿‘ãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ´ã¿ (%sç§’é–“éš”)", GRAB_INTERVAL),
        CurrentValue = false,
        Callback = function(e)
            if e then
                if not startForcedGrab() then 
                    stopForcedGrab()
                end
            else
                stopForcedGrab()
            end
        end
    })
    
    KickTab:CreateParagraph({
        Title = "â— ç¾åœ¨ã®è¨­å®š",
        Content = string.format("ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«: **%.1fç§’**\næ¤œå‡ºç¯„å›²: **%dã‚¹ã‚¿ãƒƒãƒ‰**ä»¥å†…", GRAB_INTERVAL, NEARBY_RANGE)
    })
end

createKickMenu()
